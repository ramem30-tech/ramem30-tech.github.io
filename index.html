<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Foragers - Online (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #382b22;
            color: #ffffff;
            overflow: hidden;
            image-rendering: pixelated;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }
        #loading-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(43, 33, 28, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            text-align: center;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #34d399; /* Supabase Green */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ui-container {
            position: absolute;
            bottom: 10px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            z-index: 10;
            padding: 0 20px;
            box-sizing: border-box;
            pointer-events: none;
        }
        .ui-panel {
            background-color: rgba(0, 0, 0, 0.6);
            border: 4px solid #5a4f49;
            box-shadow: 0 0 0 4px #2b211c;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: all;
        }
        .ui-panel h3 {
            font-size: 12px;
            margin-bottom: 8px;
            color: #f5f5f5;
            text-align: center;
        }
        .inventory-grid, .hotbar-grid, .crafting-grid { display: grid; gap: 4px; }
        .crafting-area { display: flex; align-items: center; gap: 10px; }
        .crafting-grid { grid-template-columns: repeat(3, 40px); grid-template-rows: repeat(3, 40px); }
        .hotbar-grid { grid-template-columns: repeat(9, 40px); }
        .inventory-slot {
            width: 40px; height: 40px; background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid #3b322d; display: flex; align-items: center;
            justify-content: center; font-size: 24px; cursor: pointer; position: relative;
        }
        .inventory-slot.selected { border-color: #ffd700; box-shadow: 0 0 5px #ffd700; }
        .item-count { position: absolute; bottom: 2px; right: 2px; font-size: 10px; color: white; text-shadow: 1px 1px 1px black; }
        .crafting-arrow { font-size: 24px; }
        #chat-panel { width: 350px; position: absolute; bottom: 10px; right: 20px; }
        .chat-container { width: 100%; height: 180px; display: flex; flex-direction: column; }
        #chat-messages { flex-grow: 1; overflow-y: auto; font-size: 10px; padding: 5px; background-color: rgba(0, 0, 0, 0.3); margin-bottom: 5px; line-height: 1.4; }
        #chat-input { width: 100%; background-color: rgba(0, 0, 0, 0.5); border: 2px solid #5a4f49; color: white; padding: 5px; font-size: 10px; }
        
        #player-info-panel { position: absolute; top: 10px; left: 10px; z-index: 10; display: flex; flex-direction: column; gap: 5px; }
        #name-container { display: flex; align-items: center; gap: 5px;}
        #name-input, #set-name-btn { background-color: rgba(0, 0, 0, 0.5); border: 2px solid #5a4f49; padding: 5px; color: white; font-size: 10px; }
        #set-name-btn { cursor: pointer; }
        #user-id-display { font-size: 10px; background-color: rgba(0,0,0,0.5); padding: 5px; border: 2px solid #5a4f49;}

        .health-bar-container { width: 392px; height: 20px; background-color: rgba(0,0,0,0.5); border: 2px solid #5a4f49; margin-bottom: 8px; }
        .health-bar { width: 100%; height: 100%; background-color: #ef4444; transition: width 0.3s ease-in-out; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <div id="loading-overlay">
        <div class="loader"></div>
        <p class="text-white text-xl mt-4">Connecting to World...</p>
        <p id="loading-error" class="text-red-400 text-sm mt-2"></p>
    </div>

    <canvas id="game-canvas"></canvas>

    <div id="player-info-panel">
        <div id="name-container">
            <input type="text" id="name-input" placeholder="Enter name..." size="15"><button id="set-name-btn">Set</button>
        </div>
        <div id="user-id-display">Share World URL to invite friends!</div>
    </div>

    <div class="ui-container">
        <!-- Main Player UI -->
        <div id="main-ui-left" class="absolute bottom-0 left-1/2 -translate-x-1/2">
            <div id="crafting-inventory-panel" class="ui-panel hidden">
                <div class="flex items-center gap-2 mb-4">
                     <h3 class="text-lg">CRAFTING</h3>
                </div>
                <div class="crafting-area">
                    <div id="crafting-grid" class="crafting-grid"></div>
                    <div class="crafting-arrow">-></div>
                    <div id="crafting-output" class="inventory-slot"></div>
                </div>
                <h3 class="text-sm mt-4">INVENTORY (E)</h3>
                <div id="inventory-grid" class="inventory-grid mt-2" style="grid-template-columns: repeat(9, 40px); grid-template-rows: repeat(2, 40px);"></div>
            </div>
            <div id="hotbar-panel" class="ui-panel">
                 <div id="health-bar-container" class="health-bar-container">
                    <div id="health-bar" class="health-bar"></div>
                </div>
                <div id="hotbar" class="hotbar-grid"></div>
            </div>
        </div>
        <!-- Chat UI -->
        <div id="chat-panel" class="ui-panel chat-container">
            <h3>CHAT</h3>
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" placeholder="Type message...">
        </div>
    </div>
    
    <div id="message-box" class="fixed top-5 right-5 bg-red-500 text-white p-4 rounded-lg shadow-xl hidden transition-opacity duration-300">
        <p id="message-text"></p>
    </div>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- DOM Elements ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = loadingOverlay.querySelector('p:not(#loading-error)');
        const loadingErrorText = document.getElementById('loading-error');
        const nameInputEl = document.getElementById('name-input');
        const setNameBtnEl = document.getElementById('set-name-btn');
        const chatMessagesEl = document.getElementById('chat-messages');
        const chatInputEl = document.getElementById('chat-input');
        
        // --- Game Config ---
        const TILE_SIZE = 32; const MAP_WIDTH = 100; const MAP_HEIGHT = 100;
        const PLAYER_SIZE = TILE_SIZE * 0.7;

        // --- Game State ---
        let supabase;
        let localPlayer = null; 
        let otherPlayers = {}; 
        let worldObjects = {};
        const keysPressed = {}; 
        const camera = { x: 0, y: 0 };
        const gameState = { worldId: null, userId: null, channel: null };
        
        const EMOJIS = { PLAYER: '‚óâ‚Äø‚óâ', OTHER_PLAYER: '‚Ä¢ÃÄ_‚Ä¢ÃÅ', AXE: 'ü™ì', PICKAXE: '‚õèÔ∏è', SWORD: '‚öîÔ∏è', WALL: 'üß±', TREE_S: 'üå≥', ROCK: 'ü™®', WOOD: 'ü™µ', STONE: 'ü™®'};
        let animationFrameId;

        // --- Main Game Functions ---
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        
        function gameLoop() { 
            if (!localPlayer) return; 
            update(); 
            render(); 
            animationFrameId = requestAnimationFrame(gameLoop); 
        }

        function update() {
            const speed = 4; let dx = 0; let dy = 0;
            if (keysPressed['w'] || keysPressed['arrowup']) dy -= 1; 
            if (keysPressed['s'] || keysPressed['arrowdown']) dy += 1;
            if (keysPressed['a'] || keysPressed['arrowleft']) dx -= 1; 
            if (keysPressed['d'] || keysPressed['arrowright']) dx += 1;
            if (dx !== 0 || dy !== 0) {
                const magnitude = Math.sqrt(dx * dx + dy * dy); 
                const velX = (dx / magnitude) * speed; 
                const velY = (dy / magnitude) * speed;
                
                localPlayer.x += velX;
                localPlayer.y += velY;

                supabase.from('players').upsert({ 
                    id: gameState.userId, 
                    world_id: gameState.worldId,
                    x: localPlayer.x, 
                    y: localPlayer.y 
                }).then();
            }
            camera.x = localPlayer.x - canvas.width / 2; 
            camera.y = localPlayer.y - canvas.height / 2;
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            ctx.save(); 
            ctx.translate(-camera.x, -camera.y);
            
            for (const id in worldObjects) {
                const obj = worldObjects[id]; 
                ctx.font = `${TILE_SIZE * 0.8}px sans-serif`; 
                ctx.textAlign = 'center'; 
                ctx.fillText(EMOJIS[obj.type] || '?', obj.x, obj.y);
            }
            
            for (const id in otherPlayers) {
                if (id === gameState.userId) continue; 
                const player = otherPlayers[id]; 
                ctx.fillStyle = 'white'; 
                ctx.font = '16px sans-serif'; 
                ctx.textAlign = 'center'; 
                ctx.fillText(EMOJIS.OTHER_PLAYER, player.x, player.y - 20); 
                ctx.font = '10px "Press Start 2P"'; 
                ctx.fillText(player.name, player.x, player.y - 40);
            }
            
            if (localPlayer) {
                ctx.fillStyle = 'yellow'; ctx.font = '16px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText(EMOJIS.PLAYER, localPlayer.x, localPlayer.y - 20);
                ctx.font = '10px "Press Start 2P"';
                ctx.fillText(localPlayer.name, localPlayer.x, localPlayer.y - 40);
            }
            ctx.restore();
        }

        // --- Supabase Functions ---
        async function initSupabase() { 
            // IMPORTANT: Replace these with your own Supabase project details
            const SUPABASE_URL = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1dW5oeGxxaW93Ymp2enlpZ3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNDk4NzcsImV4cCI6MjA3MjkyNTg3N30.SmNHkzK0XHxu10k3fTgc95tzr3MrVv723n5T4USA7jo'; 
            const SUPABASE_ANON_KEY = 'https://quunhxlqiowbjvzyigyg.supabase.co';

             if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                loadingText.textContent = `Setup Required!`; 
                loadingErrorText.innerHTML = `Please update the <strong>SUPABASE_URL</strong> and <strong>SUPABASE_ANON_KEY</strong> variables in the code.`;
                return;
            }

            try {
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                // Get or create a persistent user ID
                let userId = localStorage.getItem('forest-foragers-userId');
                if (!userId) {
                    userId = `user_${Math.random().toString(36).substr(2, 9)}`;
                    localStorage.setItem('forest-foragers-userId', userId);
                }
                gameState.userId = userId;
                await joinWorld();
            } catch (error) {
                console.error("CRITICAL: Supabase Initialization failed:", error); 
                loadingText.textContent = `Error connecting.`; 
                loadingErrorText.textContent = error.message; 
            }
        }
        
        async function joinWorld() { 
            loadingText.textContent = "Joining World..."; 
            const { data: worldData, error: worldError } = await supabase.from('worlds').select('id').eq('id', gameState.worldId).maybeSingle();
            if (worldError) throw worldError;
            if (!worldData) {
                const { error: insertError } = await supabase.from('worlds').insert({ id: gameState.worldId, name: 'New World'});
                if (insertError) throw insertError;
                await generateWorld();
            }
            await initPlayer(); 
            setupListeners(); 
            loadingOverlay.style.display = 'none'; 
            gameLoop(); 
        }

        async function generateWorld() { 
            let newObjects = [];
            for (let i = 0; i < 200; i++) { newObjects.push({ world_id: gameState.worldId, type: 'TREE_S', x: Math.random() * MAP_WIDTH * TILE_SIZE, y: Math.random() * MAP_HEIGHT * TILE_SIZE }); } 
            for (let i = 0; i < 100; i++) { newObjects.push({ world_id: gameState.worldId, type: 'ROCK', x: Math.random() * MAP_WIDTH * TILE_SIZE, y: Math.random() * MAP_HEIGHT * TILE_SIZE }); } 
            const { error } = await supabase.from('world_objects').insert(newObjects);
            if(error) console.error("Error generating world:", error);
        }

        async function initPlayer() { 
            loadingText.textContent = "Spawning..."; 
            const { data: playerData, error } = await supabase.from('players').select('*').eq('id', gameState.userId).eq('world_id', gameState.worldId).maybeSingle();
            if (error) throw error;
            if (playerData) { 
                localPlayer = playerData; 
            } else { 
                const spawnX = (MAP_WIDTH / 2) * TILE_SIZE; 
                const spawnY = (MAP_HEIGHT / 2) * TILE_SIZE; 
                localPlayer = { id: gameState.userId, world_id: gameState.worldId, x: spawnX, y: spawnY, name: `Player-${gameState.userId.substring(5, 9)}` }; 
                const { error: insertError } = await supabase.from('players').insert(localPlayer);
                if (insertError) throw insertError;
            } 
            nameInputEl.value = localPlayer.name; 
        }
        
        function setupListeners() {
            if (gameState.channel) {
                supabase.removeChannel(gameState.channel);
            }
            gameState.channel = supabase.channel(`world-${gameState.worldId}`);

            gameState.channel
                .on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, payload => {
                    const updatedPlayer = payload.new;
                    if (updatedPlayer.id === gameState.userId) {
                        localPlayer = { ...localPlayer, ...updatedPlayer };
                    } else {
                        otherPlayers[updatedPlayer.id] = updatedPlayer;
                    }
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'world_objects' }, payload => {
                     if(payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                        worldObjects[payload.new.id] = payload.new;
                     } else if (payload.eventType === 'DELETE') {
                        delete worldObjects[payload.old.id];
                     }
                })
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, payload => {
                    const msg = payload.new;
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>${msg.sender_name}:</strong> ${msg.text}`;
                    chatMessagesEl.appendChild(p);
                    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
                })
                .subscribe();

            // Initial fetch of data
            supabase.from('world_objects').select('*').eq('world_id', gameState.worldId).then(({data, error}) => { if(!error) data.forEach(obj => worldObjects[obj.id] = obj); });
            supabase.from('players').select('*').eq('world_id', gameState.worldId).then(({data, error}) => { if(!error) data.forEach(p => { if(p.id !== gameState.userId) otherPlayers[p.id] = p; }); });
        }
        
        // --- Event Handlers ---
        function addEventListeners() {
             window.addEventListener('keydown', e => { keysPressed[e.key.toLowerCase()] = true; });
             window.addEventListener('keyup', e => { keysPressed[e.key.toLowerCase()] = false; });
             setNameBtnEl.addEventListener('click', () => { 
                if (localPlayer && nameInputEl.value) { 
                    localPlayer.name = nameInputEl.value; 
                    supabase.from('players').upsert({ id: gameState.userId, world_id: gameState.worldId, name: localPlayer.name }).then(); 
                } 
            });
             chatInputEl.addEventListener('keydown', (e) => { 
                if (e.key === 'Enter' && chatInputEl.value.trim() !== '') { 
                    if (!localPlayer || !localPlayer.name) return; 
                    supabase.from('chat_messages').insert({ world_id: gameState.worldId, user_id: gameState.userId, sender_name: localPlayer.name, text: chatInputEl.value.trim() }).then();
                    chatInputEl.value = ''; 
                } 
            });
             window.addEventListener('resize', resizeCanvas);
        }

        function main() {
            resizeCanvas();
            const urlParams = new URLSearchParams(window.location.search);
            let worldParam = urlParams.get('world');
            if (!worldParam) {
                worldParam = `world_${Math.random().toString(36).substr(2, 9)}`;
            }
            gameState.worldId = worldParam;
            initSupabase();
        }
        
        main();
    </script>
</body>
</html>
```

### ‚ö†Ô∏è Important Next Steps:

Because we're using a new backend service, you'll need to do a quick one-time setup on the Supabase website to get your database ready.

1.  **Create a Supabase Project:**
    * Go to [supabase.com](https://supabase.com) and create a free account.
    * Create a new project. You can name it "Forest Foragers."

2.  **Get Your Project Keys:**
    * Inside your new project, go to the "Project Settings" (the gear icon).
    * Click on "API" in the side menu.
    * You will see a **URL** and an **`anon` public key**. You need to copy both of these.

3.  **Update the Code:**
    * In the `forest_foragers_supabase.html` file, find these two lines near the top of the `<script>` tag:
        ```javascript
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; 
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        
