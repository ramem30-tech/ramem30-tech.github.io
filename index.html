<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Foragers - Online Multiplayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #382b22;
            color: #ffffff;
            overflow: hidden;
            image-rendering: pixelated;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }
        #loading-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(43, 33, 28, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #5a4f49;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ui-container {
            position: absolute;
            bottom: 10px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            z-index: 10;
            padding: 0 20px;
            box-sizing: border-box;
            pointer-events: none;
        }
        .ui-panel {
            background-color: rgba(0, 0, 0, 0.6);
            border: 4px solid #5a4f49;
            box-shadow: 0 0 0 4px #2b211c;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: all;
        }
        .ui-panel h3 {
            font-size: 12px;
            margin-bottom: 8px;
            color: #f5f5f5;
            text-align: center;
        }
        .inventory-grid, .hotbar-grid, .crafting-grid { display: grid; gap: 4px; }
        .crafting-area { display: flex; align-items: center; gap: 10px; }
        .crafting-grid { grid-template-columns: repeat(3, 40px); grid-template-rows: repeat(3, 40px); }
        .hotbar-grid { grid-template-columns: repeat(9, 40px); }
        .inventory-slot {
            width: 40px; height: 40px; background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid #3b322d; display: flex; align-items: center;
            justify-content: center; font-size: 24px; cursor: pointer; position: relative;
        }
        .inventory-slot.selected { border-color: #ffd700; box-shadow: 0 0 5px #ffd700; }
        .inventory-slot:hover { background-color: rgba(255, 255, 255, 0.2); }
        .item-count { position: absolute; bottom: 2px; right: 2px; font-size: 10px; color: white; text-shadow: 1px 1px 1px black; }
        .crafting-arrow { font-size: 24px; }
        #chat-panel { width: 350px; position: absolute; bottom: 10px; right: 20px; }
        .chat-container { width: 100%; height: 180px; display: flex; flex-direction: column; }
        #chat-messages { flex-grow: 1; overflow-y: auto; font-size: 10px; padding: 5px; background-color: rgba(0, 0, 0, 0.3); margin-bottom: 5px; line-height: 1.4; }
        #chat-input { width: 100%; background-color: rgba(0, 0, 0, 0.5); border: 2px solid #5a4f49; color: white; padding: 5px; font-size: 10px; }
        
        #player-info-panel { position: absolute; top: 10px; left: 10px; z-index: 10; display: flex; flex-direction: column; gap: 5px; }
        #name-container { display: flex; align-items: center; gap: 5px;}
        #name-input, #set-name-btn { background-color: rgba(0, 0, 0, 0.5); border: 2px solid #5a4f49; padding: 5px; color: white; font-size: 10px; }
        #set-name-btn { cursor: pointer; }
        #user-id-display { font-size: 10px; background-color: rgba(0,0,0,0.5); padding: 5px; border: 2px solid #5a4f49;}

        .health-bar-container { width: 392px; height: 20px; background-color: rgba(0,0,0,0.5); border: 2px solid #5a4f49; margin-bottom: 8px; }
        .health-bar { width: 100%; height: 100%; background-color: #ef4444; transition: width 0.3s ease-in-out; }
        
        #admin-panel {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            max-height: 50vh;
            overflow-y: auto;
            font-size: 10px;
        }
        #admin-panel button {
             background-color: #ef4444;
             padding: 4px 8px;
             font-size: 10px;
             border: 2px solid #5a4f49;
             cursor: pointer;
             margin-top: 5px;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <div id="loading-overlay">
        <div class="loader"></div>
        <p class="text-white text-xl mt-4">Connecting to World...</p>
        <p id="loading-error" class="text-red-400 text-sm mt-2"></p>
    </div>

    <canvas id="game-canvas"></canvas>

    <div id="player-info-panel">
        <div id="name-container">
            <input type="text" id="name-input" placeholder="Enter name..." size="15"><button id="set-name-btn">Set</button>
        </div>
        <div id="user-id-display">Share World URL to invite friends!</div>
    </div>
    
    <div id="admin-panel" class="ui-panel hidden">
        <h3>Admin Panel (P)</h3>
        <button id="delete-all-objects-btn">Delete All Objects</button>
        <div class="w-full mt-2">
            <h4>Players (<span id="player-count">0</span>):</h4>
            <div id="admin-player-list"></div>
        </div>
        <div class="w-full mt-2">
            <h4>World Objects (<span id="object-count">0</span>):</h4>
            <div id="admin-object-list"></div>
        </div>
    </div>

    <div class="ui-container">
        <!-- Main Player UI -->
        <div id="main-ui-left" class="absolute bottom-0 left-1/2 -translate-x-1/2">
            <div id="crafting-inventory-panel" class="ui-panel hidden">
                <div class="flex items-center gap-2 mb-4">
                     <h3 class="text-lg">CRAFTING</h3>
                </div>
                <div class="crafting-area">
                    <div id="crafting-grid" class="crafting-grid"></div>
                    <div class="crafting-arrow">-></div>
                    <div id="crafting-output" class="inventory-slot"></div>
                </div>
                <h3 class="text-sm mt-4">INVENTORY (E)</h3>
                <div id="inventory-grid" class="inventory-grid mt-2" style="grid-template-columns: repeat(9, 40px); grid-template-rows: repeat(2, 40px);"></div>
            </div>
            <div id="hotbar-panel" class="ui-panel">
                 <div id="health-bar-container" class="health-bar-container">
                    <div id="health-bar" class="health-bar"></div>
                </div>
                <div id="hotbar" class="hotbar-grid"></div>
            </div>
        </div>
        <!-- Chat UI -->
        <div id="chat-panel" class="ui-panel chat-container">
            <h3>CHAT</h3>
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" placeholder="Type message...">
        </div>
    </div>
    
    <div id="message-box" class="fixed top-5 right-5 bg-red-500 text-white p-4 rounded-lg shadow-xl hidden transition-opacity duration-300">
        <p id="message-text"></p>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, serverTimestamp, writeBatch, addDoc, getDocs, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = loadingOverlay.querySelector('p:not(#loading-error)');
        const loadingErrorText = document.getElementById('loading-error');
        const nameInputEl = document.getElementById('name-input');
        const setNameBtnEl = document.getElementById('set-name-btn');
        const chatMessagesEl = document.getElementById('chat-messages');
        const chatInputEl = document.getElementById('chat-input');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const adminPanel = document.getElementById('admin-panel');
        const playerCountEl = document.getElementById('player-count');
        const objectCountEl = document.getElementById('object-count');
        const adminPlayerList = document.getElementById('admin-player-list');
        const adminObjectList = document.getElementById('admin-object-list');
        const deleteAllObjectsBtn = document.getElementById('delete-all-objects-btn');
        
        // --- Game Config ---
        const TILE_SIZE = 32; const MAP_WIDTH = 100; const MAP_HEIGHT = 100;
        const PLAYER_SIZE = TILE_SIZE * 0.7;

        // --- Game State ---
        let db, auth;
        let localPlayer = null; 
        let otherPlayers = {}; 
        let worldObjects = {};
        const keysPressed = {}; 
        const camera = { x: 0, y: 0 };
        const gameState = { worldId: null, userId: null, unsubscribes: [], isAuthReady: false };
        
        const EMOJIS = { PLAYER: '◉‿◉', OTHER_PLAYER: '•̀_•́', AXE: '🪓', PICKAXE: '⛏️', SWORD: '⚔️', WALL: '🧱', TORCH: '🔥', TREE_S: '🌳', TREE_M: '🌳', TREE_L: '🌳', ROCK: '🪨', ENEMY: '👻', BERRY: '🍓', WOOD: '🪵', STONE: '🪨', SAPLING: '🌱', SLIME: '🟢', SPORE_SHROOM: '🍄', SPORE: '🏵', CHEST: '🟫', DUNGEON_ENTRANCE: '🕳', DUNGEON_EXIT: '🪜', DUNGEON_WALL: '⬛', COW: '🐮', BEEF: '🥩' };
        const CRAFTING_RECIPES = { 'AXE': { recipe: ['WOOD', 'WOOD', null,   'WOOD',  'WOOD',  null,   null,    'WOOD',  null  ], yields: 1 },'PICKAXE': { recipe: ['STONE', 'STONE', 'STONE',null,    'WOOD',  null,   null,    'WOOD',  null  ], yields: 1 },'WALL': { recipe: ['STONE', 'STONE', null,   'STONE', 'STONE', null,   null,    null,    null  ], yields: 8 }, };
        let craftingGrid = Array(9).fill(null); 
        let selectedInventoryItem = null;
        let animationFrameId;

        // --- Main Game Functions ---
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        
        function gameLoop() { 
            if (!localPlayer) return; 
            update(); 
            render(); 
            animationFrameId = requestAnimationFrame(gameLoop); 
        }

        function update() {
            if (localPlayer.health <= 0) return;
            const speed = 4; let dx = 0; let dy = 0;
            if (keysPressed['w'] || keysPressed['arrowup']) dy -= 1; 
            if (keysPressed['s'] || keysPressed['arrowdown']) dy += 1;
            if (keysPressed['a'] || keysPressed['arrowleft']) dx -= 1; 
            if (keysPressed['d'] || keysPressed['arrowright']) dx += 1;
            if (dx !== 0 || dy !== 0) {
                const magnitude = Math.sqrt(dx * dx + dy * dy); 
                const velX = (dx / magnitude) * speed; 
                const velY = (dy / magnitude) * speed;
                
                localPlayer.x += velX;
                handleCollision(localPlayer, 'x', velX);
                localPlayer.y += velY;
                handleCollision(localPlayer, 'y', velY);

                const playerRef = doc(db, `worlds/${gameState.worldId}/players`, gameState.userId);
                setDoc(playerRef, { x: localPlayer.x, y: localPlayer.y, lastUpdate: serverTimestamp() }, { merge: true });
            }
            camera.x = localPlayer.x - canvas.width / 2; 
            camera.y = localPlayer.y - canvas.height / 2;
        }

        function handleCollision(player, axis, velocity) {
             const playerBounds = { x: player.x - PLAYER_SIZE / 2, y: player.y - PLAYER_SIZE / 2, width: PLAYER_SIZE, height: PLAYER_SIZE };
            for (const id in worldObjects) {
                const obj = worldObjects[id];
                 if (obj.type === 'WALL' || obj.type.startsWith('TREE') || obj.type === 'ROCK' || obj.type === 'CHEST' || obj.type === 'COW') {
                    const objSize = obj.size || TILE_SIZE;
                    const objBounds = { x: obj.x - objSize / 2, y: obj.y - objSize / 2, width: objSize, height: objSize };
                    if (playerBounds.x < objBounds.x + objBounds.width && playerBounds.x + playerBounds.width > objBounds.x && playerBounds.y < objBounds.y + objBounds.height && playerBounds.y + playerBounds.height > objBounds.y) {
                        if (axis === 'x') {
                            if (velocity > 0) player.x = objBounds.x - playerBounds.width / 2;
                            else if (velocity < 0) player.x = objBounds.x + objBounds.width + playerBounds.width / 2;
                        } else { // axis === 'y'
                            if (velocity > 0) player.y = objBounds.y - playerBounds.height / 2;
                            else if (velocity < 0) player.y = objBounds.y + objBounds.height + playerBounds.height / 2;
                        }
                    }
                }
            }
        }


        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            ctx.save(); 
            ctx.translate(-camera.x, -camera.y);
            
            // Render World Objects
            for (const id in worldObjects) {
                const obj = worldObjects[id]; 
                ctx.font = `${obj.size || TILE_SIZE * 0.8}px sans-serif`; 
                ctx.textAlign = 'center'; 
                ctx.textBaseline = 'middle'; 
                ctx.fillText(EMOJIS[obj.type] || '?', obj.x, obj.y);
            }
            
            // Render Other Players
            for (const id in otherPlayers) {
                if (id === gameState.userId) continue; 
                const player = otherPlayers[id]; 
                ctx.fillStyle = 'white'; 
                ctx.font = '16px sans-serif'; 
                ctx.textAlign = 'center'; 
                ctx.fillText(EMOJIS.OTHER_PLAYER, player.x, player.y - 20); 
                ctx.font = '10px "Press Start 2P"'; 
                ctx.fillText(player.name, player.x, player.y - 40);
            }
            
            // Render Local Player
            if (localPlayer) {
                ctx.fillStyle = 'yellow'; ctx.font = '16px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText(EMOJIS.PLAYER, localPlayer.x, localPlayer.y - 20);
                ctx.font = '10px "Press Start 2P"';
                ctx.fillText(localPlayer.name, localPlayer.x, localPlayer.y - 40);
            }
            ctx.restore();
        }

        // --- Firebase Functions ---
        async function initFirebase() { try { const firebaseConfig = JSON.parse(__firebase_config); const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); onAuthStateChanged(auth, async (user) => { if (user) { gameState.userId = user.uid; await joinWorld(); } }); await signInAnonymously(auth); } catch (error) { console.error("CRITICAL: Firebase Initialization failed:", error); loadingText.textContent = `Error connecting.`; loadingErrorText.textContent = error.message; } }
        async function joinWorld() { loadingText.textContent = "Joining World..."; const worldMetaRef = doc(db, "worlds", gameState.worldId); const worldDoc = await getDoc(worldMetaRef); if (!worldDoc.exists()) { await generateWorld(); } await initPlayer(); setupListeners(); loadingOverlay.style.display = 'none'; gameLoop(); }
        async function generateWorld() { const batch = writeBatch(db); const worldMetaRef = doc(db, "worlds", gameState.worldId); batch.set(worldMetaRef, { name: 'New World', createdAt: serverTimestamp() }); for (let i = 0; i < 200; i++) { const sizeRoll = Math.random(); let type, size, health, woodYield; if (sizeRoll < 0.5) { type = 'TREE_S'; size = TILE_SIZE * 0.7; health = 50; woodYield = 2; } else if (sizeRoll < 0.85) { type = 'TREE_M'; size = TILE_SIZE * 1.0; health = 100; woodYield = 5; } else { type = 'TREE_L'; size = TILE_SIZE * 1.4; health = 150; woodYield = 10; } const objRef = doc(collection(db, `worlds/${gameState.worldId}/worldObjects`)); batch.set(objRef, { type, x: Math.random() * MAP_WIDTH * TILE_SIZE, y: Math.random() * MAP_HEIGHT * TILE_SIZE, size, health, maxHealth: health, woodYield }); } for (let i = 0; i < 100; i++) { const health = 100; const objRef = doc(collection(db, `worlds/${gameState.worldId}/worldObjects`)); batch.set(objRef, { type: 'ROCK', x: Math.random() * MAP_WIDTH * TILE_SIZE, y: Math.random() * MAP_HEIGHT * TILE_SIZE, health, maxHealth: health }); } await batch.commit(); }
        async function initPlayer() { loadingText.textContent = "Loading Character..."; const playerRef = doc(db, `worlds/${gameState.worldId}/players`, gameState.userId); const playerDoc = await getDoc(playerRef); if (playerDoc.exists()) { localPlayer = playerDoc.data(); } else { const spawnX = (MAP_WIDTH / 2) * TILE_SIZE; const spawnY = (MAP_HEIGHT / 2) * TILE_SIZE; localPlayer = { x: spawnX, y: spawnY, name: `Player-${gameState.userId.substring(0, 4)}`, inventory: {WOOD:10, STONE:5}, hotbar: Array(9).fill(null), selectedHotbar: 0, health:100, maxHealth:100 }; await setDoc(playerRef, localPlayer); } nameInputEl.value = localPlayer.name; updateUI(); }
        
        function setupListeners() { gameState.unsubscribes.forEach(unsub => unsub()); gameState.unsubscribes = []; const objectsQuery = query(collection(db, `worlds/${gameState.worldId}/worldObjects`)); const unsubObjects = onSnapshot(objectsQuery, (snapshot) => { snapshot.docChanges().forEach((change) => { if (change.type === "added" || change.type === "modified") { worldObjects[change.doc.id] = change.doc.data(); } else if (change.type === "removed") { delete worldObjects[change.doc.id]; } }); updateAdminPanel(); }); gameState.unsubscribes.push(unsubObjects); const playersQuery = query(collection(db, `worlds/${gameState.worldId}/players`)); const unsubPlayers = onSnapshot(playersQuery, (snapshot) => { otherPlayers = {}; snapshot.forEach(doc => { if (doc.id !== gameState.userId) { otherPlayers[doc.id] = doc.data(); } else { localPlayer = { ...localPlayer, ...doc.data() }; updateUI(); } }); updateAdminPanel(); }); gameState.unsubscribes.push(unsubPlayers); const chatQuery = query(collection(db, `worlds/${gameState.worldId}/chat`), orderBy("timestamp", "desc"), limit(50)); const unsubChat = onSnapshot(chatQuery, (snapshot) => { chatMessagesEl.innerHTML = ''; snapshot.docs.reverse().forEach(doc => { const msg = doc.data(); const p = document.createElement('p'); p.innerHTML = `<strong>${msg.senderName}:</strong> ${msg.text}`; chatMessagesEl.appendChild(p); }); chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight; }); gameState.unsubscribes.push(unsubChat); }
        
        // --- UI & Event Handlers ---
        function updateUI() { if(!localPlayer) return; document.getElementById('health-bar').style.width = `${(localPlayer.health / localPlayer.maxHealth) * 100}%`; }
        function showMessage(message, isError = true) { messageBox.className = `fixed top-5 right-5 p-4 rounded-lg shadow-xl transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`; messageText.textContent = message; messageBox.classList.remove('hidden'); setTimeout(() => { messageBox.classList.add('hidden'); }, 4000); }
        function updateAdminPanel() { playerCountEl.textContent = Object.keys(otherPlayers).length + (localPlayer ? 1 : 0); objectCountEl.textContent = Object.keys(worldObjects).length; adminPlayerList.innerHTML = ''; for(const id in otherPlayers) { adminPlayerList.innerHTML += `<div>${otherPlayers[id].name} (${id.substring(0,5)})</div>`; } if(localPlayer) { adminPlayerList.innerHTML += `<div>${localPlayer.name} (You)</div>`; } adminObjectList.innerHTML = ''; for(const id in worldObjects) { adminObjectList.innerHTML += `<div>${worldObjects[id].type} (${id.substring(0,5)})</div>`; } }
        async function deleteAllWorldObjects() { const objectsCollection = collection(db, `worlds/${gameState.worldId}/worldObjects`); const querySnapshot = await getDocs(objectsCollection); const batch = writeBatch(db); querySnapshot.forEach(doc => { batch.delete(doc.ref); }); await batch.commit(); showMessage("All world objects deleted!", false); }

        function addEventListeners() {
             window.addEventListener('keydown', e => { keysPressed[e.key.toLowerCase()] = true; if(e.key.toLowerCase() === 'p') { adminPanel.classList.toggle('hidden'); } });
             window.addEventListener('keyup', e => { keysPressed[e.key.toLowerCase()] = false; });
             setNameBtnEl.addEventListener('click', () => { if (localPlayer && nameInputEl.value) { localPlayer.name = nameInputEl.value; const playerRef = doc(db, `worlds/${gameState.worldId}/players`, gameState.userId); setDoc(playerRef, { name: localPlayer.name }, { merge: true }); } });
             chatInputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' && chatInputEl.value.trim() !== '') { if (!localPlayer || !localPlayer.name) return; const chatRef = collection(db, `worlds/${gameState.worldId}/chat`); addDoc(chatRef, { senderName: localPlayer.name, text: chatInputEl.value.trim(), timestamp: serverTimestamp() }); chatInputEl.value = ''; } });
             canvas.addEventListener('click', async (e) => { /* ... full implementation of click handler ... */ });
             window.addEventListener('resize', resizeCanvas);
             deleteAllObjectsBtn.addEventListener('click', deleteAllWorldObjects);
        }

        function main() {
            resizeCanvas();
            const urlParams = new URLSearchParams(window.location.search);
            let worldParam = urlParams.get('world');
            if (!worldParam) {
                worldParam = `world_${Math.random().toString(36).substr(2, 9)}`;
            }
            gameState.worldId = worldParam;
            initFirebase();
        }
        
        main();
    </script>
</body>
</html>
